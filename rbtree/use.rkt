#lang editor racket

(require "tree.rkt"
         "rbtree.rkt")

(define (balance t)
  (match t
    [(or
      #editor((4)
 0
 ()
 2
 (".."
  (mpi
   (c submod c (p* up #"tree.rkt") c deserializer c (? . 0) q editor)
   .
   #f))
 ()
 (c
  (c (? . 1) q tree$)
  c
  (c (mpi (c submod c (? . 0) q deserializer) ? . 1) q tree$:deserialize)
  c
  (c (mpi (c submod c (? . 0)) ? . 1) q tree$:elaborate)))((4)
 2
 (((submod (relative up #"tree.rkt") deserializer) . node$:deserialize)
  ((submod (relative up #"tree.rkt") deserializer) . tree$:deserialize))
 7
 ((h - (equal))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "D") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "y") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "x") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "A") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "B") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "C") (type . subtree)))))
 ()
 (1
  0
  (v!
   (v!
    (v!
     (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
     list-block$$
     (h - (equal) (focus . #f)))
    vertical-block$
    (? . 0))
   tree$
   (h
    -
    (equal)
    (root ? . 1)
    (nodes
     c
     (c
      (0
       0
       (v!
        (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
        node$
        (h - (equal) (name u . "z") (type . black))))
      c
      107
      c
      24
      c
      (c (c (? . 2) . default-value) c (c (? . 1) . default-value)))
     c
     (c
      (? . 2)
      c
      74
      c
      106
      c
      (c (c (? . 3) . default-value) c (c (? . 6) . default-value)))
     c
     (c
      (? . 3)
      c
      25
      c
      190
      c
      (c (c (? . 5) . default-value) c (c (? . 4) . default-value)))
     c
     (c (? . 4) q 13 297 ())
     c
     (c (? . 5) q 77 292 ())
     c
     (c (? . 6) q 134 195 ())
     c
     (c (? . 1) q 175 95 ())))))) #editor((4)
 0
 ()
 2
 (".."
  (mpi
   (c submod c (p* up #"tree.rkt") c deserializer c (? . 0) q editor)
   .
   #f))
 ()
 (c
  (c (? . 1) q tree$)
  c
  (c (mpi (c submod c (? . 0) q deserializer) ? . 1) q tree$:deserialize)
  c
  (c (mpi (c submod c (? . 0)) ? . 1) q tree$:elaborate)))((4)
 2
 (((submod (relative up #"tree.rkt") deserializer) . node$:deserialize)
  ((submod (relative up #"tree.rkt") deserializer) . tree$:deserialize))
 7
 ((h - (equal))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "D") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "x") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "y") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "C") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "B") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "A") (type . subtree)))))
 ()
 (1
  0
  (v!
   (v!
    (v!
     (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
     list-block$$
     (h - (equal) (focus . #f)))
    vertical-block$
    (? . 0))
   tree$
   (h
    -
    (equal)
    (root ? . 1)
    (nodes
     c
     (c
      (0
       0
       (v!
        (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
        node$
        (h - (equal) (name u . "z") (type . black))))
      c
      92
      c
      20
      c
      (c (c (? . 2) . default-value) c (c (? . 1) . default-value)))
     c
     (c
      (? . 3)
      c
      117
      c
      186
      c
      (c (c (? . 5) . default-value) c (c (? . 4) . default-value)))
     c
     (c
      (? . 2)
      c
      38
      c
      100
      c
      (c (c (? . 3) . default-value) c (c (? . 6) . default-value)))
     c
     (c (? . 1) q 155 92 ())
     c
     (c (? . 4) q 163 282 ())
     c
     (c (? . 5) q 83 294 ())
     c
     (c (? . 6) q 20 179 ())))))) #editor((4)
 0
 ()
 2
 (".."
  (mpi
   (c submod c (p* up #"tree.rkt") c deserializer c (? . 0) q editor)
   .
   #f))
 ()
 (c
  (c (? . 1) q tree$)
  c
  (c (mpi (c submod c (? . 0) q deserializer) ? . 1) q tree$:deserialize)
  c
  (c (mpi (c submod c (? . 0)) ? . 1) q tree$:elaborate)))((4)
 2
 (((submod (relative up #"tree.rkt") deserializer) . node$:deserialize)
  ((submod (relative up #"tree.rkt") deserializer) . tree$:deserialize))
 7
 ((h - (equal))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "z") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "y") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "D") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "C") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "B") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "A") (type . subtree)))))
 ()
 (1
  0
  (v!
   (v!
    (v!
     (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
     list-block$$
     (h - (equal) (focus . #f)))
    vertical-block$
    (? . 0))
   tree$
   (h
    -
    (equal)
    (root ? . 3)
    (nodes
     c
     (c
      (0
       0
       (v!
        (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
        node$
        (h - (equal) (name u . "x") (type . black))))
      c
      48
      c
      24
      c
      (c (c (? . 1) . default-value) c (c (? . 6) . default-value)))
     c
     (c
      (? . 2)
      c
      70
      c
      207
      c
      (c (c (? . 5) . default-value) c (c (? . 4) . default-value)))
     c
     (c
      (? . 1)
      c
      102
      c
      106
      c
      (c (c (? . 2) . default-value) c (c (? . 3) . default-value)))
     c
     (c (? . 3) q 197 208 ())
     c
     (c (? . 4) q 137 296 ())
     c
     (c (? . 5) q 55 298 ())
     c
     (c (? . 6) q 6 107 ())))))) #editor((4)
 0
 ()
 2
 (".."
  (mpi
   (c submod c (p* up #"tree.rkt") c deserializer c (? . 0) q editor)
   .
   #f))
 ()
 (c
  (c (? . 1) q tree$)
  c
  (c (mpi (c submod c (? . 0) q deserializer) ? . 1) q tree$:deserialize)
  c
  (c (mpi (c submod c (? . 0)) ? . 1) q tree$:elaborate)))((4)
 2
 (((submod (relative up #"tree.rkt") deserializer) . node$:deserialize)
  ((submod (relative up #"tree.rkt") deserializer) . tree$:deserialize))
 7
 ((h - (equal))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "D") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "y") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "z") (type . red))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "C") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "B") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "A") (type . subtree)))))
 ()
 (1
  0
  (v!
   (v!
    (v!
     (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
     list-block$$
     (h - (equal) (focus . #f)))
    vertical-block$
    (? . 0))
   tree$
   (h
    -
    (equal)
    (root ? . 1)
    (nodes
     c
     (c
      (0
       0
       (v!
        (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
        node$
        (h - (equal) (name u . "x") (type . black))))
      c
      76
      c
      10
      c
      (c (c (? . 2) . default-value) c (c (? . 6) . default-value)))
     c
     (c
      (? . 3)
      c
      176
      c
      186
      c
      (c (c (? . 4) . default-value) c (c (? . 1) . default-value)))
     c
     (c
      (? . 2)
      c
      119
      c
      95
      c
      (c (c (? . 3) . default-value) c (c (? . 5) . default-value)))
     c
     (c (? . 1) q 226 297 ())
     c
     (c (? . 4) q 124 300 ())
     c
     (c (? . 5) q 77 198 ())
     c
     (c (? . 6) q 14 88 ())))))))
     ; =>
     #editor((4)
 0
 ()
 2
 (".."
  (mpi
   (c submod c (p* up #"tree.rkt") c deserializer c (? . 0) q editor)
   .
   #f))
 ()
 (c
  (c (? . 1) q tree$)
  c
  (c (mpi (c submod c (? . 0) q deserializer) ? . 1) q tree$:deserialize)
  c
  (c (mpi (c submod c (? . 0)) ? . 1) q tree$:elaborate)))((4)
 2
 (((submod (relative up #"tree.rkt") deserializer) . node$:deserialize)
  ((submod (relative up #"tree.rkt") deserializer) . tree$:deserialize))
 7
 ((h - (equal))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "D") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "z") (type . black))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "x") (type . black))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "C") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "B") (type . subtree))))
  (0
   0
   (v!
    (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
    node$
    (h - (equal) (name u . "A") (type . subtree)))))
 ()
 (1
  0
  (v!
   (v!
    (v!
     (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
     list-block$$
     (h - (equal) (focus . #f)))
    vertical-block$
    (? . 0))
   tree$
   (h
    -
    (equal)
    (root ? . 1)
    (nodes
     c
     (c
      (? . 2)
      c
      198
      c
      131
      c
      (c (c (? . 4) . default-value) c (c (? . 1) . default-value)))
     c
     (c
      (? . 3)
      c
      47
      c
      123
      c
      (c (c (? . 5) . default-value) c (c (? . 6) . default-value)))
     c
     (c
      (0
       0
       (v!
        (v! (v! (v! #f base$ (? . 0)) get-path$$ (? . 0)) widget$ (? . 0))
        node$
        (h - (equal) (name u . "y") (type . red))))
      c
      93
      c
      13
      c
      (c (c (? . 2) . default-value) c (c (? . 3) . default-value)))
     c
     (c (? . 1) q 250 244 ())
     c
     (c (? . 4) q 146 238 ())
     c
     (c (? . 5) q 82 219 ())
     c
     (c (? . 6) q 9 224 ()))))))]
    [else t]))

(balance (mk-tree #:color 'black
                  #:left (mk-tree #:color 'red
                                  #:left (mk-tree #:color 'red))))
